# Step by Step Guide


1) Clone this sample repo [nordmart-review](https://github.com/stakater-lab/stakater-nordmart-review)

2) Install following tools:

- `Tilt` v0.22.11 or above
- `Docker` 20.10.8 or above
- `Helm` 3 or above
- `oc` binaries

And this sample application please install these tools as well `java 11` and `maven 3`

3) Enable sandbox namespace/project/environment for your tenant; you can read more [here](https://docs.cloud.stakater.com/content/sre/tenant-operator/customresources.html#_1-tenant)

4) Login to cluster

```bash
oc login --token=<TOKEN> --server=<SERVER>
```

5) Switch project to sandbox namespace/project/environment

```bash
oc project <MY-SANDBOX>
```

6) Login to OpenShift internal docker registry

First get the OpenShift internal docker registry URL and set in HOST variable name

```bash
HOST=image-registry-openshift-image-registry.apps.[CLUSTER-NAME].[CLUSTER-ID].kubeapp.cloud
```
NOTE: Ask SCA (SAAP Cluster Admin) or cluster-admin to provide you the OpenShift internal registry route

Then login into docker registry with following command

```bash
docker login -u $(oc whoami) -p $(oc whoami -t) $HOST
```

If you get this error `x509: certificate signed by unknown authority` then you need to update your `/etc/docker/daemon.json` file and add the insecure registry

```bash
{
    "insecure-registries" : [ "HOST" ]
}
```

7) (Optional) Add helm chart repos

If you reference helm charts from private registry then you first need to add it

```bash
cd deploy

# helm credentials can be found in vault or in a secret in build namespace
helm repo add stakater-nexus <private repo url> --username helm-user-name --password ********; 
```

8) Update helm dependencies

```bash
helm dependency update

cd ..
```

9) Go through the [Tiltfile](https://github.com/stakater-lab/stakater-nordmart-review/blob/main/Tiltfile) of the application 

[Here](./tiltfile-content.md) is a sample Tiltfile for a Java based project with a specific [Dockerfile](./dockerfile-content.md).

This sample tiltfile requires that you have both `maven` and `java` installed locally as well

10) Check the `local_resource` section in the Tiltfile

Make sure the app jar file name under `local_resource` matches with the jar name generated by your application in target folder
 
11) Add `tilt_options.json` file to your application

Should be created locally by everyone in base directory and it should have following content as per the user.

```json
{
    "namespace": "tilt-username-sandbox",
    "default_registry": "image-registry-openshift-image-registry.apps.[CLUSTER-NAME].[CLUSTER-ID].kubeapp.cloud/{}",
    "allow_k8s_contexts": "tilt-username-sandbox/api-[CLUSTER-NAME]-[CLUSTER-ID]-kubeapp-cloud:6443/user@email.com"
}
```

User email in `allow_k8s_contexts` should be same email that is used as tenant member email. To get `allow_k8s_contexts` run this command

```
oc config current-context
```

NOTE: Remember `tilt_options.json` should be git ignored

12) Go through the `.gitigore` and check tilt and helm specific ignores

```
# Tilt
tilt_options.json
tilt_modules/

# Helm
/deploy/charts
```

13) Go through `.tiltignore`

```
**/charts
**/tmpcharts
```

14) Go through `values-local.yaml` in a `tilt` folder in base application directory. 

`values-local.yaml` should contain the following content. Make sure that replica count should always be 1.

```yaml
application:
    
  deployment:
    imagePullSecrets: null

    # Tilt live update only supports one replica
    replicas: 1

    image:
      tag: null
```

15) Run `tilt up` at base directory 

Press space key to view the progress in Tilt web UI. The application should be running in the namespace used in `tilt_options.json` file.

16) Run `tilt down` to delete the application and related configuration from the namespace
